<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Peta Banjir Rob</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* WARNA LAUT (Background) */
        #map { 
            width: 100%; 
            height: 100vh; 
            background-color: #344680; /* Biru Tua */
        }
        
        .info-panel {
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            width: 300px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        h3 { margin-top: 0; color: #344680; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px;}
        
        /* Style Input Search */
        .search-group { margin-bottom: 15px; position: relative; }
        .search-group label { font-size: 12px; font-weight: bold; color: #555; display: block; margin-bottom: 5px; }
        input[type="text"] {
            width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
        }

        /* Style Input Tanggal (Updated) */
        .date-section {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #eee;
            margin-bottom: 15px;
        }
        .date-label-main {
            font-weight: bold; /* Sesuai Request */
            font-size: 13px;
            display: block;
            margin-bottom: 8px;
            color: #333;
        }
        .date-row {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            font-size: 13px;
        }
        .date-row span {
            width: 60px; /* Lebar label 'Mulai =' */
            color: #555;
        }
        .date-row input {
            flex-grow: 1;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        /* Style Hasil Pencarian */
        #search-results {
            list-style: none; padding: 0; margin: 0; max-height: 150px; overflow-y: auto;
            border: 1px solid #eee; border-top: none; display: none; background: white;
            position: absolute; width: 100%; z-index: 1001; box-sizing: border-box;
        }
        #search-results li {
            padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 13px;
        }
        #search-results li:hover { background-color: #f0f0f0; }

        /* List Wilayah */
        .list-wrapper {
            flex-grow: 1; overflow-y: auto; margin-top: 5px; border-top: 1px solid #eee; padding-top: 10px;
        }
        .list-container { font-size: 13px; }
        .list-container ul { padding-left: 20px; margin: 5px 0; }
        .list-container li { margin-bottom: 3px; }

        .btn-reset {
            background: #e74c3c; color: white; border: none; padding: 10px; cursor: pointer;
            border-radius: 4px; width: 100%; font-weight: bold; margin-top: 15px;
        }
        .btn-reset:hover { background: #c0392b; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="info-panel">
        <h3>⚠️ Generator Peringatan</h3>
        
        <div class="search-group">
            <label for="search-box">Cari Wilayah:</label>
            <input type="text" id="search-box" placeholder="Ketik nama kabupaten..." autocomplete="off">
            <ul id="search-results"></ul>
        </div>

        <div class="date-section">
            <label class="date-label-main">Tanggal berlaku</label>
            
            <div class="date-row">
                <span>Mulai =</span>
                <input type="date" id="tgl-mulai">
            </div>
            
            <div class="date-row">
                <span>Sampai =</span>
                <input type="date" id="tgl-selesai">
            </div>
        </div>

        <div class="list-wrapper">
            <p style="font-size:12px; color:#666; margin-top:0;">Wilayah terpilih:</p>
            <div id="list-wilayah" class="list-container">
                <em>Belum ada wilayah dipilih</em>
            </div>
        </div>

        <button class="btn-reset" onclick="resetPeta()">Reset Peta</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <script>
        // --- KONFIGURASI ---
        const DAFTAR_LUAR_NEGERI = ["Malaysia", "Brunai", "Timor Leste", "Papua New Guinea", "Singapura"]; 
        
        // Set Default Tanggal (Hari ini dan Besok)
        var today = new Date();
        var tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);

        document.getElementById('tgl-mulai').valueAsDate = today;
        document.getElementById('tgl-selesai').valueAsDate = tomorrow;

        // --- 1. INISIALISASI PETA ---
        var map = L.map('map', { zoomControl: false, attributionControl: false }).setView([-2.5489, 118.0149], 5);
        var geojsonLayer;
        var selectedNames = new Set();
        var allFeaturesData = []; 

        // Helper: Ambil Nama
        function getNamaWilayah(feature) {
            var p = feature.properties;
            // Cek berbagai kemungkinan nama kolom, jika tidak ada kembalikan "Tanpa Nama"
            var nama = p.KABUPATEN || p.WADMKK || p.NAMOBJ || p.NAME_2 || p.Name;
            
            if (!nama || nama.trim() === "") {
                return "Tanpa Nama";
            }
            return nama;
        }

        // Helper: Cek Luar Negeri
        function isLuarNegeri(feature) {
            var nama = getNamaWilayah(feature);
            return DAFTAR_LUAR_NEGERI.includes(nama);
        }

        // --- 2. STYLE MANAGEMENT ---
        
        // Style Daratan Indonesia (Hijau)
        function styleIndo(feature) {
            return { fillColor: '#56e37c', weight: 0.5, color: '#0d104f', fillOpacity: 1 };
        }
        
        // Style Luar Negeri (Abu-abu Tua #adadb8)
        function styleForeign(feature) {
            return { fillColor: '#adadb8', weight: 0.5, color: '#0d104f', fillOpacity: 1, interactive: false };
        }

        // Style Tanpa Nama (Abu-abu Muda #bcc0cf) - NEW!
        function styleNoName(feature) {
            return { fillColor: '#bcc0cf', weight: 0.5, color: '#0d104f', fillOpacity: 1, interactive: false };
        }

        // Style Terpilih (Merah)
        function styleSelected(feature) {
            return { fillColor: '#ff0000', weight: 1, color: 'white', fillOpacity: 1 };
        }

        // LOGIKA PENENTUAN WARNA
        function getStyle(feature) {
            var nama = getNamaWilayah(feature);

            // 1. Cek Priority: Luar Negeri?
            if (isLuarNegeri(feature)) return styleForeign(feature);

            // 2. Cek Priority: Apakah "Tanpa Nama"? (Data kosong)
            if (nama === "Tanpa Nama") return styleNoName(feature);

            // 3. Cek Priority: Apakah sedang dipilih user?
            if (selectedNames.has(nama)) return styleSelected(feature);

            // 4. Default: Daratan Indonesia
            return styleIndo(feature);
        }

        // --- 3. INTERAKSI ---
        
        function updateMapStyle() {
            geojsonLayer.eachLayer(function(l) {
                l.setStyle(getStyle(l.feature));
                if (selectedNames.has(getNamaWilayah(l.feature))) {
                    l.bringToFront();
                }
            });
            updatePanelList();
        }

        function toggleSelection(nama) {
            if (nama === "Tanpa Nama") return; // Cegah error klik area kosong

            if (selectedNames.has(nama)) {
                selectedNames.delete(nama);
            } else {
                selectedNames.add(nama);
            }
            updateMapStyle();
        }

        function saatDiklik(e) {
            var nama = getNamaWilayah(e.target.feature);
            toggleSelection(nama);
        }

        function updatePanelList() {
            var divList = document.getElementById('list-wilayah');
            var listHtml = "<ul>";
            var count = 0;
            
            // Urutkan nama abjad
            var sortedNames = Array.from(selectedNames).sort();

            sortedNames.forEach(function(nama) {
                listHtml += "<li><strong>PESISIR " + nama.toUpperCase() + "</strong></li>";
                count++;
            });
            listHtml += "</ul>";

            divList.innerHTML = (count === 0) ? "<em>Belum ada wilayah dipilih</em>" : listHtml;
        }

        // --- 4. FITUR SEARCH ---
        var searchBox = document.getElementById('search-box');
        var resultsBox = document.getElementById('search-results');

        searchBox.addEventListener('keyup', function(e) {
            var keyword = e.target.value.toLowerCase();
            resultsBox.innerHTML = "";
            
            if (keyword.length < 3) { 
                resultsBox.style.display = 'none'; return;
            }

            // Filter: Bukan Luar Negeri AND Bukan "Tanpa Nama"
            var uniqueNames = [...new Set(allFeaturesData
                .filter(f => !isLuarNegeri(f) && getNamaWilayah(f) !== "Tanpa Nama")
                .map(f => getNamaWilayah(f)))];

            var matches = uniqueNames.filter(name => name.toLowerCase().includes(keyword));

            if (matches.length > 0) {
                resultsBox.style.display = 'block';
                matches.slice(0, 10).forEach(nama => { 
                    var li = document.createElement('li');
                    li.textContent = nama;
                    li.onclick = function() { pilihDariSearch(nama); };
                    resultsBox.appendChild(li);
                });
            } else {
                resultsBox.style.display = 'none';
            }
        });

        function pilihDariSearch(namaTarget) {
            selectedNames.add(namaTarget);
            updateMapStyle();

            var groupBounds = L.latLngBounds([]);
            var found = false;
            geojsonLayer.eachLayer(function(layer) {
                if (getNamaWilayah(layer.feature) === namaTarget) {
                    groupBounds.extend(layer.getBounds());
                    found = true;
                }
            });
            if (found) { map.fitBounds(groupBounds, { padding: [50, 50] }); }
            
            searchBox.value = "";
            resultsBox.style.display = 'none';
        }
        
        document.addEventListener('click', function(e) {
            if (e.target !== searchBox && e.target !== resultsBox) {
                resultsBox.style.display = 'none';
            }
        });

        // --- 5. LOAD DATA ---
        function onEachFeature(feature, layer) {
            var nama = getNamaWilayah(feature);
            // Hanya bisa diklik jika BUKAN luar negeri dan BUKAN tanpa nama
            if (!isLuarNegeri(feature) && nama !== "Tanpa Nama") {
                layer.on({ click: saatDiklik });
            }
        }

        window.resetPeta = function() {
            selectedNames.clear();
            updateMapStyle();
            map.setView([-2.5489, 118.0149], 5);
        }

        fetch('IdKabupaten.json')
            .then(response => response.json())
            .then(data => {
                allFeaturesData = data.features;
                geojsonLayer = L.geoJson(data, {
                    style: getStyle,
                    onEachFeature: onEachFeature
                }).addTo(map);
                map.fitBounds(geojsonLayer.getBounds());
            })
            .catch(error => { console.error("Error:", error); alert("Gagal load data IdKabupaten.json"); });

    </script>
</body>
</html>
