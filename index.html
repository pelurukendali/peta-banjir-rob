<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Peta Banjir Rob</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* WARNA LAUT (Background) */
        #map { 
            width: 100%; 
            height: 100vh; 
            background-color: #3862eb; /* Biru Tua */
        }
        
        .info-panel {
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            width: 280px;
            max-height: 90vh;
            overflow-y: auto;
        }

        h3 { margin-top: 0; color: #0d104f; }
        
        /* Style Input Tanggal */
        .input-group { margin-bottom: 15px; }
        label { font-size: 12px; font-weight: bold; color: #555; display: block; margin-bottom: 5px; }
        input[type="date"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: inherit;
            box-sizing: border-box; /* Agar padding gak bikin lebar */
        }

        /* Tombol Reset */
        .btn-reset {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 4px;
            width: 100%;
            font-weight: bold;
            margin-top: 15px;
            transition: 0.3s;
        }
        .btn-reset:hover { background: #c0392b; }

        .list-container {
            margin-top: 10px;
            font-size: 13px;
        }
        .list-container ul { padding-left: 20px; margin: 5px 0; }
        .list-container li { margin-bottom: 3px; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="info-panel">
        <h3>⚠️ Generator Peringatan</h3>
        
        <div class="input-group">
            <label for="tanggal">Tanggal Berlaku:</label>
            <input type="date" id="tanggal" onchange="updateTanggal()">
        </div>

        <p style="font-size:12px; color:#666;">Klik wilayah untuk menandai.</p>
        <hr>
        
        <div id="list-wilayah" class="list-container">
            <em>Belum ada wilayah dipilih</em>
        </div>

        <button class="btn-reset" onclick="resetPeta()">Reset Peta</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <script>
        // --- KONFIGURASI ---
        // Masukkan nama-nama wilayah luar negeri di sini (sesuai data atributmu)
        // Contoh: "Malaysia", "Timor Leste", "Sabah". 
        // Penulisan harus PERSIS sama dengan di data (huruf besar/kecil).
        const DAFTAR_LUAR_NEGERI = ["Malaysia", "Brunai", "Timor Leste", "Papua New Guinea", "Singapura"]; 
        
        // Atur tanggal hari ini sebagai default input
        document.getElementById('tanggal').valueAsDate = new Date();


        // --- 1. INISIALISASI PETA ---
        var map = L.map('map', {
            zoomControl: false, 
            attributionControl: false 
        }).setView([-2.5489, 118.0149], 5);

        var geojsonLayer;
        var selectedNames = new Set(); // Menyimpan NAMA unik wilayah yang dipilih

        // Helper: Ambil Nama Wilayah dari Feature
        function getNamaWilayah(feature) {
            var p = feature.properties;
            // Urutan prioritas pengecekan nama kolom
            return p.KABUPATEN || p.WADMKK || p.NAMOBJ || p.NAME_2 || p.Name || "Tanpa Nama";
        }

        // Helper: Cek apakah ini Luar Negeri?
        function isLuarNegeri(feature) {
            var nama = getNamaWilayah(feature);
            // Cek apakah nama wilayah ada di dalam daftar DAFTAR_LUAR_NEGERI
            // Atau logic lain: misal ID-nya bukan format Indonesia
            return DAFTAR_LUAR_NEGERI.includes(nama);
        }


        // --- 2. STYLE MANAGEMENT ---
        
        // Style Daratan Indonesia (Hijau)
        function styleIndo(feature) {
            return {
                fillColor: '#56e37c', 
                weight: 0.5,
                color: '#0d104f',     
                fillOpacity: 1
            };
        }

        // Style Luar Negeri (Abu-abu)
        function styleForeign(feature) {
            return {
                fillColor: '#adadb8', // Abu-abu request user
                weight: 0.5,
                color: '#0d104f',
                fillOpacity: 1,
                interactive: false // Biar gak bisa diklik
            };
        }

        // Style Terpilih (Merah)
        function styleSelected(feature) {
            return {
                fillColor: '#ff0000', 
                weight: 1,
                color: 'white',
                fillOpacity: 1
            };
        }

        // Fungsi Penentu Style Utama
        function getStyle(feature) {
            var nama = getNamaWilayah(feature);
            
            // 1. Cek dulu apakah ini Luar Negeri?
            if (isLuarNegeri(feature)) {
                return styleForeign(feature);
            }

            // 2. Cek apakah namanya ada di daftar yang dipilih (selectedNames)?
            if (selectedNames.has(nama)) {
                return styleSelected(feature);
            }

            // 3. Kalau bukan keduanya, berarti daratan Indonesia biasa
            return styleIndo(feature);
        }


        // --- 3. LOGIKA KLIK & GROUP SELECT ---
        
        function saatDiklik(e) {
            var layer = e.target;
            var nama = getNamaWilayah(layer.feature);

            // Toggle logic: Kalau sudah ada, hapus. Kalau belum, tambah.
            if (selectedNames.has(nama)) {
                selectedNames.delete(nama); // Deselect
            } else {
                selectedNames.add(nama);    // Select
            }

            // UPDATE SEMUA LAYER (Agar pulau-pulau kecil ikut berubah)
            geojsonLayer.eachLayer(function(l) {
                // Kita reset style layer ini berdasarkan logic getStyle terbaru
                l.setStyle(getStyle(l.feature));
                
                // Jika terpilih, bawa ke depan
                if (selectedNames.has(getNamaWilayah(l.feature))) {
                    l.bringToFront();
                }
            });

            // Update info panel
            updatePanelList();
        }

        function updatePanelList() {
            var divList = document.getElementById('list-wilayah');
            var listHtml = "<ul>";
            var count = 0;

            // Loop Set selectedNames
            selectedNames.forEach(function(nama) {
                // Tambahkan kata "PESISIR" di depannya
                listHtml += "<li><strong>PESISIR " + nama.toUpperCase() + "</strong></li>";
                count++;
            });
            listHtml += "</ul>";

            if (count === 0) {
                divList.innerHTML = "<em>Belum ada wilayah dipilih</em>";
            } else {
                divList.innerHTML = listHtml;
            }
        }


        // --- 4. DATA LOADING & EVENT ---

        function onEachFeature(feature, layer) {
            // Hanya aktifkan klik jika BUKAN luar negeri
            if (!isLuarNegeri(feature)) {
                layer.on({
                    click: saatDiklik
                });
            }
        }

        window.resetPeta = function() {
            selectedNames.clear();
            geojsonLayer.eachLayer(function(l) {
                l.setStyle(getStyle(l.feature));
            });
            updatePanelList();
        }
        
        // Fungsi placeholder tanggal (kalau mau dipakai untuk generate teks juga)
        window.updateTanggal = function() {
            console.log("Tanggal berubah:", document.getElementById('tanggal').value);
        }

        fetch('IdKabupaten.json')
            .then(response => response.json())
            .then(data => {
                geojsonLayer = L.geoJson(data, {
                    style: getStyle, // Gunakan fungsi getStyle pintar tadi
                    onEachFeature: onEachFeature
                }).addTo(map);
                
                map.fitBounds(geojsonLayer.getBounds());
            })
            .catch(error => {
                console.error("Error:", error);
                alert("Gagal load data. Pastikan IdKabupaten.json ada.");
            });

    </script>
</body>
</html>
