<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Peringatan Dini Banjir Pesisir</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* --- 1. GLOBAL STYLE --- */
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; overflow: hidden; }
        
        /* Container Utama */
        .main-wrapper { display: flex; height: 100vh; width: 100vw; }

        /* --- 2. CONTROL PANEL (KIRI) --- */
        .control-panel {
            width: 340px;
            background: #f4f4f4;
            display: flex;
            flex-direction: column;
            z-index: 1000;
            transition: transform 0.3s ease;
            position: relative;
            box-shadow: 2px 0 10px rgba(0,0,0,0.5);
            flex-shrink: 0; /* Jangan menyusut */
        }

        /* Mode Minimize */
        .control-panel.collapsed {
            transform: translateX(-340px);
        }

        /* Tombol Toggle (Minimize/Open) */
        .toggle-btn {
            position: absolute;
            top: 15px;
            right: -40px; /* Keluar dari panel */
            width: 40px;
            height: 40px;
            background: #0d104f;
            color: white;
            border: none;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            z-index: 1001;
        }

        /* Header Control Panel */
        .panel-header {
            padding: 15px;
            background: #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ccc;
        }
        .panel-header h3 { margin: 0; color: #333; font-size: 16px; font-weight: bold; }
        
        /* Button Minimize Kecil di Header (Sesuai Request 1.d) */
        .btn-mini-toggle {
            background: transparent; border: 1px solid #999; color: #333;
            width: 25px; height: 25px; border-radius: 4px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-mini-toggle:hover { background: #ccc; }

        /* Isi Scrollable Control Panel */
        .panel-content {
            padding: 15px;
            overflow-y: auto;
            flex-grow: 1;
        }

        /* --- FORM ELEMENTS --- */
        .input-group { margin-bottom: 12px; }
        label { font-size: 11px; font-weight: bold; color: #555; display: block; margin-bottom: 4px; text-transform: uppercase; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 13px; }
        
        /* Dropdown Jenis Peta */
        #jenis-peta { font-weight: bold; color: #0d104f; border: 2px solid #0d104f; }

        /* Area Bawah (Reset & Preview) */
        .panel-footer {
            padding: 15px;
            border-top: 1px solid #ddd;
            background: #fff;
        }
        .btn { width: 100%; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; margin-bottom: 10px; }
        .btn-reset { background: #e74c3c; }
        .btn-preview { background: #27ae60; font-size: 14px; margin-bottom: 0;}
        .btn:hover { opacity: 0.9; }

        /* Search & List Styles */
        #search-results { list-style: none; padding: 0; margin: 0; max-height: 100px; overflow-y: auto; border: 1px solid #eee; display: none; background: white; }
        #search-results li { padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 12px; }
        #search-results li:hover { background: #f0f0f0; }
        .mini-list { font-size: 11px; max-height: 80px; overflow-y: auto; border: 1px solid #eee; padding: 5px; background: #fafafa; margin-bottom: 10px; }


        /* --- 3. WORKSPACE (CANVAS AREA) --- */
        .workspace {
            flex-grow: 1;
            background: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
            position: relative;
            padding: 20px;
        }

        /* --- 4. POSTER CANVAS (ASPECT RATIO 4320 x 1350) --- */
        /* Kita set base width setengahnya (2160px) di CSS biar browser kuat render previewnya. 
           Nanti saat download kita Scale 2x jadi 4320px. */
        #poster-canvas {
            width: 2160px; 
            height: 675px; /* Sesuai rasio 4320x1350 (3.2:1) */
            position: relative;
            /* Gradient Background 45 Derajat */
            background: linear-gradient(45deg, #070a5c, #060842);
            color: white;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            /* Transform Scale agar muat di layar laptop saat preview */
            transform-origin: center center;
            transform: scale(0.4); /* Default zoom out biar kelihatan semua */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 5px solid white; /* Border estetik */
        }

        /* Layout Grid di dalam Poster */
        .poster-header {
            padding: 20px 40px;
            text-align: center;
            background: rgba(0,0,0,0.3);
            border-bottom: 2px solid rgba(255,255,255,0.2);
            z-index: 10;
        }
        .poster-title-main { font-size: 48px; font-weight: 800; text-transform: uppercase; margin: 0; letter-spacing: 2px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .poster-subtitle { font-size: 24px; margin-top: 10px; color: #eee; font-weight: 300; }
        .poster-subtitle strong { font-weight: 700; color: #ffeb3b; }

        .poster-warning-text {
            padding: 15px 50px;
            background: rgba(196, 20, 20, 0.8); /* Background merah transparan */
            color: white;
            font-size: 20px;
            text-align: center;
            line-height: 1.4;
            font-weight: 500;
            z-index: 10;
        }

        .poster-map-area {
            flex-grow: 1;
            position: relative;
            width: 100%;
            background: #29509e; /* Warna Laut Default (Backup) */
        }

        .poster-footer-area {
            padding: 15px 50px;
            background: #060842;
            text-align: center;
            font-size: 20px;
            border-top: 2px solid rgba(255,255,255,0.2);
            z-index: 10;
        }
        
        #map { width: 100%; height: 100%; background: transparent; }

        /* --- 5. PREVIEW MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 9999;
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .modal-content {
            background: white; padding: 20px; border-radius: 8px; max-width: 90%; text-align: center;
        }
        .modal-preview-img {
            max-width: 100%; max-height: 70vh; border: 1px solid #ddd; display: block; margin: 10px auto;
        }
        .modal-buttons { display: flex; gap: 10px; justify-content: center; }
        .btn-download { background: #2980b9; width: auto; padding: 10px 30px;}
        .btn-cancel { background: #7f8c8d; width: auto; padding: 10px 30px;}

    </style>
</head>
<body>

<div class="main-wrapper">
    
    <div class="control-panel" id="sidebar">
        <div class="panel-header">
            <h3>KONFIGURASI PETA</h3>
            <button class="btn-mini-toggle" onclick="toggleSidebar()" title="Minimize Panel">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>

        <button class="toggle-btn" onclick="toggleSidebar()" style="display:none;" id="btn-reopen">
            <i class="fas fa-cog"></i>
        </button>

        <div class="panel-content">
            <div class="input-group">
                <label>Jenis Peta</label>
                <select id="jenis-peta" onchange="updatePosterText()">
                    <option value="PERINGATAN BANJIR PESISIR">Peringatan Banjir Pesisir</option>
                    <option value="REKAPITULASI KEJADIAN BANJIR PESISIR">Rekapitulasi Kejadian Banjir Pesisir</option>
                </select>
            </div>

            <div class="input-group">
                <label>Tanggal Peringatan</label>
                <div style="display:flex; gap:5px;">
                    <input type="date" id="tgl-mulai" onchange="updatePosterText()">
                    <input type="date" id="tgl-selesai" onchange="updatePosterText()">
                </div>
            </div>

            <div class="input-group">
                <label>Fenomena</label>
                <input type="text" id="fenomena-1" placeholder="Cth: Fase Bulan Baru" oninput="updatePosterText()">
                <select id="logic-fenomena" onchange="updatePosterText()" style="margin:5px 0;">
                    <option value="dan">dan</option>
                    <option value="atau">atau</option>
                    <option value="dan/atau">dan/atau</option>
                </select>
                <input type="text" id="fenomena-2" placeholder="Cth: Perigee (Opsional)" oninput="updatePosterText()">
            </div>

            <div class="input-group">
                <label>Waktu Kejadian</label>
                <input type="text" id="waktu-fenomena" placeholder="Cth: 13 Januari 2025" oninput="updatePosterText()">
            </div>

            <div class="input-group" style="position:relative;">
                <label>Cari Wilayah</label>
                <input type="text" id="search-box" placeholder="Ketik nama kabupaten..." autocomplete="off">
                <ul id="search-results"></ul>
            </div>

            <label>Wilayah Terpilih:</label>
            <div id="list-wilayah" class="mini-list"><em>Belum ada wilayah</em></div>

        </div>

        <div class="panel-footer">
            <button class="btn btn-reset" onclick="resetPeta()">
                <i class="fas fa-trash"></i> Reset Peta
            </button>
            <button class="btn btn-preview" onclick="openPreviewModal()">
                <i class="fas fa-image"></i> Preview Output
            </button>
        </div>
    </div>

    <div class="workspace">
        
        <div id="poster-canvas">
            
            <div class="poster-header">
                <h1 class="poster-title-main" id="txt-judul">PERINGATAN BANJIR PESISIR</h1>
                <div class="poster-subtitle">
                    <span id="txt-tanggal">Tanggal ...</span> | 
                    <span id="txt-fenomena">Fenomena ...</span> | 
                    <span id="txt-waktu">Waktu ...</span>
                </div>
            </div>

            <div class="poster-warning-text">
                <span id="txt-narasi">
                    Adanya fenomena ... pada tanggal ... berpotensi meningkatkan ketinggian air laut maksimum. 
                    Berdasarkan pantauan data water level dan prediksi pasang surut, banjir pesisir (rob) berpotensi terjadi di beberapa wilayah pesisir Indonesia.
                </span>
            </div>

            <div class="poster-map-area">
                <div id="map"></div>
            </div>

            <div class="poster-footer-area">
                Masyarakat dihimbau untuk selalu waspada dan siaga untuk mengantisipasi dampak dari Pasang Maksimum Air Laut 
                serta memperhatikan update informasi cuaca maritim dari BMKG.
            </div>

        </div>
    </div>

</div>

<div class="modal-overlay" id="previewModal">
    <div class="modal-content">
        <h3 style="color:#333; margin-top:0;">Preview Output Gambar</h3>
        <p style="font-size:12px; color:#666;">Ukuran Asli: 4320 x 1350 pixel (High Resolution)</p>
        
        <img id="final-preview-img" class="modal-preview-img" src="" alt="Preview">
        
        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closePreviewModal()">Batal</button>
            <button class="btn btn-download" onclick="downloadFinalImage()">
                <i class="fas fa-download"></i> Download PNG
            </button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<script>
    // --- 1. SETUP SYSTEM & DATA ---
    
    // Auto scale canvas agar pas di layar laptop user
    function fitCanvasToScreen() {
        const workspace = document.querySelector('.workspace');
        const canvas = document.getElementById('poster-canvas');
        const margin = 40;
        
        const availableWidth = workspace.clientWidth - margin;
        const availableHeight = workspace.clientHeight - margin;
        
        const scaleX = availableWidth / 2160;
        const scaleY = availableHeight / 675;
        const scale = Math.min(scaleX, scaleY, 0.9); // Max scale 0.9

        canvas.style.transform = `scale(${scale})`;
    }
    window.addEventListener('resize', fitCanvasToScreen);
    setTimeout(fitCanvasToScreen, 100); // Trigger saat load

    // Setup Tanggal Default
    const today = new Date();
    const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('tgl-mulai').valueAsDate = today;
    document.getElementById('tgl-selesai').valueAsDate = tomorrow;


    // --- 2. SETUP PETA (LEAFLET) ---
    // Inisialisasi peta tanpa kontrol zoom bawaan (biar bersih)
    var map = L.map('map', { 
        zoomControl: false, 
        attributionControl: false,
        zoomSnap: 0.25 
    }).setView([-2.5, 118], 5); // Zoom level disesuaikan untuk melihat Indonesia utuh

    var geojsonLayer;
    var selectedNames = new Set();
    var allFeaturesData = []; 

    // Helper: Ambil Nama Wilayah
    function getNamaWilayah(feature) {
        var p = feature.properties;
        var nama = p.KABUPATEN || p.WADMKK || p.NAMOBJ || p.NAME_2 || p.Name;
        // Asumsi: Kalau nama kosong atau null, berarti luar negeri / data invalid
        if (!nama || nama.trim() === "") return null;
        return nama;
    }

    // --- 3. STYLE & LOGIC WARNA (SESUAI REQUEST 2.d & 2.e) ---
    
    // Warna Laut sudah diatur di CSS .poster-map-area (#29509e)
    // Warna Daratan Biasa (#52b04c)
    function styleIndo(feature) { 
        return { fillColor: '#52b04c', weight: 0.5, color: '#29509e', fillOpacity: 1 }; 
    }
    
    // Warna Luar Negeri / Tanpa Nama (Abu-abu)
    function styleForeign(feature) { 
        return { fillColor: '#adadb8', weight: 0.5, color: '#29509e', fillOpacity: 1, interactive: false }; 
    }
    
    // Warna Terpilih (#c41414)
    function styleSelected(feature) { 
        return { fillColor: '#c41414', weight: 1.5, color: '#fff', fillOpacity: 1 }; 
    }

    function getStyle(feature) {
        var nama = getNamaWilayah(feature);
        if (!nama) return styleForeign(feature); // Tidak ada nama = Luar Negeri
        if (selectedNames.has(nama)) return styleSelected(feature);
        return styleIndo(feature);
    }


    // --- 4. INTERAKSI USER ---

    function updateMapStyle() {
        geojsonLayer.eachLayer(function(l) {
            l.setStyle(getStyle(l.feature));
            // Jika terpilih, taruh di layer paling atas agar garis putihnya kelihatan
            if (getNamaWilayah(l.feature) && selectedNames.has(getNamaWilayah(l.feature))) {
                l.bringToFront();
            }
        });
        updatePanelList();
    }

    // Logic Klik: Pilih berdasarkan nama (Group Selection - 2.c)
    function saatDiklik(e) {
        var nama = getNamaWilayah(e.target.feature);
        if (!nama) return; // Ignore klik luar negeri

        if (selectedNames.has(nama)) {
            selectedNames.delete(nama);
        } else {
            selectedNames.add(nama);
        }
        updateMapStyle();
    }

    // Load GeoJSON
    fetch('IdKabupaten.json')
        .then(response => response.json())
        .then(data => {
            allFeaturesData = data.features;
            geojsonLayer = L.geoJson(data, {
                style: getStyle,
                onEachFeature: function(feature, layer) {
                    // Hanya aktifkan interaksi jika punya nama
                    if (getNamaWilayah(feature)) {
                        layer.on({ click: saatDiklik });
                    }
                }
            }).addTo(map);
            
            // Fit Bounds ke seluruh Indonesia agar peta utuh (2.a / 3.c)
            map.fitBounds(geojsonLayer.getBounds());
        })
        .catch(err => { console.error(err); alert("Gagal memuat IdKabupaten.json"); });


    // --- 5. UPDATE TEXT POSTER ---

    function formatTanggal(dateStr) {
        if(!dateStr) return "...";
        const d = new Date(dateStr);
        return d.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
    }

    function updatePosterText() {
        // 1. Judul Peta
        const judul = document.getElementById('jenis-peta').value;
        document.getElementById('txt-judul').innerText = judul;

        // 2. Tanggal
        const t1 = document.getElementById('tgl-mulai').value;
        const t2 = document.getElementById('tgl-selesai').value;
        const strTanggal = `${formatTanggal(t1)} - ${formatTanggal(t2)}`;
        document.getElementById('txt-tanggal').innerText = strTanggal;

        // 3. Fenomena
        const f1 = document.getElementById('fenomena-1').value || "...";
        const f2 = document.getElementById('fenomena-2').value;
        const logic = document.getElementById('logic-fenomena').value;
        let strFenomena = f1;
        if (f2 && f2.trim()) strFenomena += ` ${logic} ${f2}`;
        document.getElementById('txt-fenomena').innerText = strFenomena;

        // 4. Waktu Kejadian
        const waktu = document.getElementById('waktu-fenomena').value || "...";
        document.getElementById('txt-waktu').innerText = `Waktu Kejadian: ${waktu}`;

        // 5. Narasi Paragraf (Sesuai format 3.4)
        const narasi = `Adanya ${strFenomena} pada tanggal ${waktu} berpotensi meningkatkan ketinggian air laut maksimum. Berdasarkan pantauan data water level dan prediksi pasang surut, banjir pesisir (rob) berpotensi terjadi di beberapa wilayah pesisir Indonesia.`;
        document.getElementById('txt-narasi').innerText = narasi;
    }
    
    // Trigger awal
    updatePosterText();


    // --- 6. FITUR CONTROL PANEL (SEARCH & MINIMIZE) ---

    // Toggle Sidebar
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const btnReopen = document.getElementById('btn-reopen');
        sidebar.classList.toggle('collapsed');
        
        if(sidebar.classList.contains('collapsed')) {
            btnReopen.style.display = 'flex';
        } else {
            btnReopen.style.display = 'none';
        }
        setTimeout(fitCanvasToScreen, 300); // Re-center canvas
    }

    // Fitur Search
    const searchBox = document.getElementById('search-box');
    const resultsBox = document.getElementById('search-results');

    searchBox.addEventListener('keyup', (e) => {
        const kw = e.target.value.toLowerCase();
        resultsBox.innerHTML = "";
        if(kw.length < 3) { resultsBox.style.display = 'none'; return; }

        // Filter nama unik
        const uniqueNames = [...new Set(allFeaturesData
            .map(f => getNamaWilayah(f))
            .filter(n => n !== null))];
        
        const matches = uniqueNames.filter(n => n.toLowerCase().includes(kw)).slice(0, 10);
        
        if(matches.length > 0) {
            resultsBox.style.display = 'block';
            matches.forEach(nama => {
                const li = document.createElement('li');
                li.innerText = nama;
                li.onclick = () => {
                    selectedNames.add(nama);
                    updateMapStyle();
                    
                    // Zoom to location (2.a)
                    const bounds = L.latLngBounds([]);
                    geojsonLayer.eachLayer(l => {
                        if(getNamaWilayah(l.feature) === nama) bounds.extend(l.getBounds());
                    });
                    if(bounds.isValid()) map.fitBounds(bounds, { padding: [50,50] });

                    searchBox.value = "";
                    resultsBox.style.display = 'none';
                };
                resultsBox.appendChild(li);
            });
        } else { resultsBox.style.display = 'none'; }
    });

    // Update List Wilayah
    function updatePanelList() {
        const div = document.getElementById('list-wilayah');
        const list = Array.from(selectedNames).sort();
        if(list.length === 0) { div.innerHTML = "<em>Belum ada wilayah</em>"; return; }
        
        let html = "<ul>";
        list.forEach(n => html += `<li>${n}</li>`);
        html += "</ul>";
        div.innerHTML = html;
    }

    // Reset Peta
    window.resetPeta = function() {
        selectedNames.clear();
        updateMapStyle();
        map.fitBounds(geojsonLayer.getBounds()); // Balik ke view Indonesia full
    }


    // --- 7. GENERATOR OUTPUT & PREVIEW (Sesuai Poin 3) ---

    let generatedCanvasBlob = null; // Menyimpan data gambar sementara

    // Buka Modal Preview
    function openPreviewModal() {
        const modal = document.getElementById('previewModal');
        const imgPreview = document.getElementById('final-preview-img');
        const element = document.getElementById('poster-canvas');
        
        // Ubah kursor jadi loading
        document.body.style.cursor = 'wait';

        // Pastikan Peta Full Extent Sebelum Capture (3.c)
        // Kita paksa peta zoom ke bounds GeoJSON agar seluruh Indonesia terlihat
        if (geojsonLayer) {
            map.fitBounds(geojsonLayer.getBounds());
        }

        // Tunggu sebentar biar animasi zoom peta selesai, baru capture
        setTimeout(() => {
            // Scale 2x dari 2160px = 4320px width (Target Resolusi)
            html2canvas(element, {
                scale: 2, 
                useCORS: true,
                allowTaint: true,
                backgroundColor: null // Transparan background handled by CSS
            }).then(canvas => {
                generatedCanvasBlob = canvas.toDataURL("image/png");
                imgPreview.src = generatedCanvasBlob;
                modal.style.display = 'flex';
                document.body.style.cursor = 'default';
            }).catch(err => {
                console.error(err);
                alert("Gagal generate preview.");
                document.body.style.cursor = 'default';
            });
        }, 800); // Delay 0.8 detik
    }

    // Tutup Modal
    window.closePreviewModal = function() {
        document.getElementById('previewModal').style.display = 'none';
    }

    // Download Gambar Final
    window.downloadFinalImage = function() {
        if(!generatedCanvasBlob) return;
        const link = document.createElement('a');
        link.download = 'Peta_Banjir_Pesisir_HD.png';
        link.href = generatedCanvasBlob;
        link.click();
        closePreviewModal();
    }

</script>
</body>
</html>
