<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Peringatan Dini Banjir Pesisir</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }
        
        /* --- LAYOUT UTAMA --- */
        #main-wrapper { display: flex; height: 100vh; position: relative; }

        /* PETA KERJA */
        #map-work { 
            flex-grow: 1; height: 100%; background-color: #29509e; z-index: 1;
        }

        /* SIDEBAR */
        .sidebar {
            width: 340px; /* Sedikit diperlebar agar judul muat */
            background: #ffffff;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            z-index: 10;
            transition: width 0.3s ease;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        /* LOGIC MINIMIZE (FIX 1.a) */
        .sidebar.collapsed { width: 50px; }
        .sidebar.collapsed .sidebar-app-title,
        .sidebar.collapsed .sidebar-header h3,
        .sidebar.collapsed .sidebar-content,
        .sidebar.collapsed .sidebar-footer { display: none; } /* Semua elemen dalam hilang kecuali tombol toggle */
        .sidebar.collapsed .toggle-btn i { transform: rotate(180deg); }
        .sidebar.collapsed .sidebar-header { justify-content: center; padding: 15px 0; }

        /* Judul Aplikasi (FIX 1.b) */
        .sidebar-app-title {
            background: #0d104f;
            color: white;
            padding: 15px;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            line-height: 1.4;
            border-bottom: 3px solid #e74c3c;
        }

        .sidebar-header {
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
        }
        .sidebar-header h3 { margin: 0; font-size: 14px; color: #555; font-weight: bold; text-transform: uppercase; }
        
        .toggle-btn { background: none; border: none; cursor: pointer; color: #555; padding: 5px; font-size: 16px; }

        .sidebar-content { padding: 15px; overflow-y: auto; flex-grow: 1; }
        .sidebar-footer { padding: 15px; border-top: 1px solid #eee; background: #fff; }

        /* INPUT STYLES */
        .input-group { margin-bottom: 12px; }
        label { font-size: 11px; font-weight: bold; color: #555; display: block; margin-bottom: 4px; }
        select, input[type="text"], input[type="date"] {
            width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 12px;
        }
        .row-inputs { display: flex; gap: 5px; align-items: center; }
        
        /* Search */
        #search-results {
            list-style: none; padding: 0; margin: 0; max-height: 100px; overflow-y: auto;
            border: 1px solid #eee; display: none; background: white;
        }
        #search-results li { padding: 6px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 11px; }
        #search-results li:hover { background: #f0f0f0; }
        
        .mini-list { font-size: 11px; height: 80px; overflow-y: auto; border: 1px solid #eee; padding: 5px; background: #fafafa; }

        /* BUTTONS */
        .btn { border: none; padding: 10px; cursor: pointer; border-radius: 4px; width: 100%; font-weight: bold; color: white; margin-bottom: 8px; font-size: 13px; }
        .btn-reset { background: #e74c3c; }
        .btn-preview { background: #2980b9; margin-bottom: 0; }
        .btn-preview:hover { background: #3498db; }

        /* --- MODAL PREVIEW --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 2000;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 10px; border-radius: 8px; 
            display: flex; flex-direction: column; align-items: center;
            max-height: 95vh; overflow: hidden;
        }
        .modal-body { 
            background: #333; overflow: auto; padding: 10px; border: 1px solid #ccc;
            max-height: 80vh; /* Agar scrollable jika layar laptop kecil */
        }

        /* --- POSTER OUTPUT (1080 x 1350) --- */
        /* Kita set ukuran display setengahnya (540x675) agar muat di layar */
        /* Nanti saat download di-scale 2x jadi 1080x1350 */
        #poster-container {
            width: 540px;  
            height: 675px; 
            position: relative;
            flex-shrink: 0;
            background: linear-gradient(45deg, #070a5c, #060842);
            color: white;
            font-family: Arial, sans-serif;
            overflow: hidden;
            display: flex; flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .poster-content {
            padding: 20px 25px;
            text-align: center;
            z-index: 5;
        }
        .poster-title { font-size: 20px; font-weight: bold; margin-bottom: 5px; text-transform: uppercase; color: #fff; letter-spacing: 1px; border-bottom: 2px solid #f1c40f; padding-bottom: 8px; display: inline-block;}
        .poster-subtitle { font-size: 13px; margin-top: 5px; margin-bottom: 5px; color: #aab7ff; font-weight: bold; }
        
        .poster-text-block {
            background: rgba(0,0,0,0.3);
            border-left: 3px solid #f1c40f;
            padding: 8px 12px;
            margin: 10px auto;
            width: 90%;
            font-size: 11px;
            line-height: 1.4;
            text-align: left;
        }

        #map-print-wrapper {
            flex-grow: 1;
            margin: 0 25px 10px 25px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            background: #29509e;
        }
        #map-print { width: 125%; height: 125%; pointer-events: none;}

        .poster-footer {
            padding: 8px 20px;
            background: rgba(0,0,0,0.5);
            text-align: center;
            font-size: 10px;
            font-weight: bold;
            color: #f1c40f;
            line-height: 1.3;
        }
    </style>
</head>
<body>

<div id="main-wrapper">
    
    <div class="sidebar" id="sidebar">
        <div class="sidebar-app-title">
            GENERATOR PERINGATAN / REKAPITULASI<br>BANJIR ROB INDONESIA
        </div>

        <div class="sidebar-header">
            <h3 id="sidebar-sub-title">Konfigurasi Peta</h3>
            <button class="toggle-btn" onclick="toggleSidebar()" title="Minimize/Maximize">
                <i class="fa-solid fa-chevron-left"></i>
            </button>
        </div>

        <div class="sidebar-content">
            <div class="input-group">
                <label>Jenis Peta:</label>
                <select id="jenis-peta">
                    <option value="Peringatan Banjir Pesisir">Peringatan Banjir Pesisir</option>
                    <option value="Rekapitulasi Kejadian Banjir Pesisir">Rekapitulasi Kejadian Banjir Pesisir</option>
                </select>
            </div>

            <div class="input-group">
                <label>Tanggal Peringatan:</label>
                <div class="row-inputs">
                    <input type="date" id="tgl-mulai">
                    <span style="font-size:10px">-</span>
                    <input type="date" id="tgl-selesai">
                </div>
            </div>

            <div class="input-group">
                <label>Fenomena:</label>
                <input type="text" id="fenomena-1" placeholder="Cth: Fase Bulan Baru">
                <div class="row-inputs" style="margin:5px 0;">
                    <select id="logic-fenomena" style="width: 80px;">
                        <option value="dan">dan</option>
                        <option value="atau">atau</option>
                        <option value="dan/atau">dan/atau</option>
                    </select>
                    <input type="text" id="fenomena-2" placeholder="Fenomena 2 (Opsional)">
                </div>
            </div>

            <div class="input-group">
                <label>Waktu Kejadian:</label>
                <input type="text" id="waktu-fenomena" placeholder="Cth: 13 Januari 2025">
            </div>

            <div class="input-group" style="position:relative;">
                <label>Cari Wilayah:</label>
                <input type="text" id="search-box" placeholder="Ketik kabupaten..." autocomplete="off">
                <ul id="search-results"></ul>
            </div>

            <label>Wilayah Terpilih:</label>
            <div id="list-wilayah" class="mini-list"><em>Belum ada</em></div>
        </div>

        <div class="sidebar-footer">
            <button class="btn btn-reset" onclick="resetPeta()">
                <i class="fa-solid fa-rotate-left"></i> Reset Peta
            </button>
            <button class="btn btn-preview" onclick="bukaPreview()">
                <i class="fa-solid fa-image"></i> Preview Output
            </button>
        </div>
    </div>

    <div id="map-work"></div>
</div>

<div class="modal-overlay" id="modal-preview">
    <div class="modal-content">
        <div style="width:100%; display:flex; justify-content:space-between; margin-bottom:5px;">
            <span style="font-weight:bold;">Preview Output (1080 x 1350 px)</span>
            <button onclick="tutupPreview()" style="border:none; background:none; cursor:pointer; font-size:18px;">&times;</button>
        </div>
        
        <div class="modal-body">
            <div id="poster-container">
                <div class="poster-content">
                    <div class="poster-title" id="out-judul">JUDUL PETA</div>
                    <div class="poster-subtitle" id="out-tanggal">Tanggal: -</div>
                    
                    <div class="poster-text-block">
                        <span id="out-narasi">...</span>
                    </div>
                </div>

                <div id="map-print-wrapper">
                    <div id="map-print"></div>
                </div>

                <div class="poster-footer">
                    Masyarakat dihimbau untuk selalu waspada dan siaga untuk mengantisipasi dampak dari Pasang Maksimum Air Laut serta memperhatikan update informasi cuaca maritim dari BMKG
                </div>
            </div>
        </div>

        <div style="margin-top:10px; width:100%;">
            <button class="btn" style="background:#27ae60;" onclick="downloadImage()">
                <i class="fa-solid fa-download"></i> Download Gambar (.PNG)
            </button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<script>
    // --- KONFIGURASI DATA ---
    const GEOJSON_FILE = 'IdKabupaten.json'; 
    const HEX_LAUT = '#29509e';
    const HEX_DARAT = '#52b04c';
    const HEX_PILIH = '#c41414';
    const HEX_ABU = '#bdc3c7'; 

    var mapWork, mapPrint; 
    var geojsonLayerWork, geojsonLayerPrint; 
    var rawGeoData = null; 
    var selectedNames = new Set(); 

    // Date Setup
    var today = new Date();
    var tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('tgl-mulai').valueAsDate = today;
    document.getElementById('tgl-selesai').valueAsDate = tomorrow;

    // --- PETA KERJA (WORK) ---
    mapWork = L.map('map-work', { zoomControl: false, attributionControl: false }).setView([-2.5, 118], 5);
    L.control.zoom({ position: 'topright' }).addTo(mapWork);

    function getStyle(feature, isPrint = false) {
        var nama = getNamaWilayah(feature);
        if (nama === "Tanpa Nama") return { fillColor: HEX_ABU, weight: 0.5, color: HEX_LAUT, fillOpacity: 1, interactive: false };
        if (selectedNames.has(nama)) return { fillColor: HEX_PILIH, weight: 1, color: 'white', fillOpacity: 1 };
        return { fillColor: HEX_DARAT, weight: 0.5, color: HEX_LAUT, fillOpacity: 1 };
    }

    function getNamaWilayah(feature) {
        var p = feature.properties;
        var nama = p.KABUPATEN || p.WADMKK || p.NAMOBJ || p.NAME_2 || p.Name;
        return (!nama || nama.trim() === "") ? "Tanpa Nama" : nama;
    }

    function onFeatureClick(e) {
        var nama = getNamaWilayah(e.target.feature);
        if (nama === "Tanpa Nama") return;
        selectedNames.has(nama) ? selectedNames.delete(nama) : selectedNames.add(nama);
        geojsonLayerWork.setStyle(f => getStyle(f, false));
        updateListPanel();
    }

    function updateListPanel() {
        var divList = document.getElementById('list-wilayah');
        var namesArr = Array.from(selectedNames).sort();
        divList.innerHTML = namesArr.length === 0 ? "<em>Belum ada</em>" : "<ul>" + namesArr.map(n => `<li>${n}</li>`).join('') + "</ul>";
    }

    fetch(GEOJSON_FILE)
        .then(res => res.json())
        .then(data => {
            rawGeoData = data; 
            geojsonLayerWork = L.geoJson(data, {
                style: f => getStyle(f, false),
                onEachFeature: (f, l) => {
                    if (getNamaWilayah(f) !== "Tanpa Nama") l.on('click', onFeatureClick);
                }
            }).addTo(mapWork);
            mapWork.fitBounds(geojsonLayerWork.getBounds());
        })
        .catch(err => alert("Gagal memuat GeoJSON."));


    // --- UI LOGIC ---
    function toggleSidebar() {
        var sb = document.getElementById('sidebar');
        sb.classList.toggle('collapsed');
        setTimeout(() => mapWork.invalidateSize(), 300);
    }

    function resetPeta() {
        selectedNames.clear();
        geojsonLayerWork.setStyle(f => getStyle(f, false));
        updateListPanel();
        mapWork.fitBounds(geojsonLayerWork.getBounds());
    }

    var searchBox = document.getElementById('search-box');
    var resultsBox = document.getElementById('search-results');
    
    searchBox.addEventListener('keyup', (e) => {
        if(!rawGeoData) return;
        var key = e.target.value.toLowerCase();
        resultsBox.innerHTML = "";
        if(key.length < 3) { resultsBox.style.display = 'none'; return; }

        var allNames = rawGeoData.features.map(f => getNamaWilayah(f)).filter(n => n !== "Tanpa Nama");
        var uniqueNames = [...new Set(allNames)];
        var matches = uniqueNames.filter(n => n.toLowerCase().includes(key)).slice(0, 10);

        if(matches.length > 0) {
            resultsBox.style.display = 'block';
            matches.forEach(name => {
                var li = document.createElement('li'); li.textContent = name;
                li.onclick = () => {
                    selectedNames.add(name); 
                    geojsonLayerWork.setStyle(f => getStyle(f, false));
                    updateListPanel();
                    var feats = rawGeoData.features.filter(f => getNamaWilayah(f) === name);
                    var tempL = L.geoJson(feats);
                    mapWork.fitBounds(tempL.getBounds());
                    searchBox.value = ""; resultsBox.style.display = 'none';
                };
                resultsBox.appendChild(li);
            });
        } else { resultsBox.style.display = 'none'; }
    });


    // --- PREVIEW & PRINT ---
    function formatTanggal(d) {
        return d ? new Date(d).toLocaleDateString('id-ID', {day:'numeric', month:'long', year:'numeric'}) : "...";
    }

    function bukaPreview() {
        // Isi Teks
        var jenis = document.getElementById('jenis-peta').value;
        var tgl1 = formatTanggal(document.getElementById('tgl-mulai').value);
        var tgl2 = formatTanggal(document.getElementById('tgl-selesai').value);
        var fen1 = document.getElementById('fenomena-1').value || "-";
        var fen2 = document.getElementById('fenomena-2').value;
        var logic = document.getElementById('logic-fenomena').value;
        var waktuKejadian = document.getElementById('waktu-fenomena').value || "-";
        var fenText = fen1 + (fen2 && fen2.trim() !== "" ? ` ${logic} ${fen2}` : "");

        document.getElementById('out-judul').innerText = jenis;
        document.getElementById('out-tanggal').innerText = `Tanggal: ${tgl1} - ${tgl2}`;
        document.getElementById('out-narasi').innerText = `Adanya ${fenText} pada tanggal ${waktuKejadian} berpotensi meningkatkan ketinggian air laut maksimum. Berdasarkan pantauan data water level dan prediksi pasang surut, banjir pesisir (rob) berpotensi terjadi di beberapa wilayah pesisir Indonesia.`;

        document.getElementById('modal-preview').style.display = 'flex';

        // Initialize Map Print (FIX 2.a: STATIC / TIDAK BERGERAK)
        if (!mapPrint) {
            mapPrint = L.map('map-print', { 
                zoomControl: false, 
                attributionControl: false,
                dragging: false,      // User gabisa geser
                scrollWheelZoom: false, // Gabisa scroll
                doubleClickZoom: false,
                boxZoom: false,
                keyboard: false
            });
        }
        
        mapPrint.eachLayer(l => mapPrint.removeLayer(l));

        if (rawGeoData) {
            geojsonLayerPrint = L.geoJson(rawGeoData, {
                style: f => getStyle(f, true)
            }).addTo(mapPrint);

            if (selectedNames.size > 0) {
                var selectedFeatures = rawGeoData.features.filter(f => selectedNames.has(getNamaWilayah(f)));
                var tempLayer = L.geoJson(selectedFeatures);
                mapPrint.fitBounds(tempLayer.getBounds(), { padding: [10, 10] });
            } else {
                mapPrint.fitBounds(geojsonLayerPrint.getBounds());
            }
        }
        setTimeout(() => mapPrint.invalidateSize(), 200);
    }

    function tutupPreview() {
        document.getElementById('modal-preview').style.display = 'none';
    }

    // FIX 2.b: Download 1080x1350
    function downloadImage() {
        var el = document.getElementById('poster-container');
        var btn = document.querySelector('.modal-content .btn');
        var oriText = btn.innerHTML;
        btn.innerHTML = "<i class='fa-solid fa-spinner fa-spin'></i> Rendering...";

        // Scale 2 pada base 540x675 akan menghasilkan 1080x1350
        html2canvas(el, {
            scale: 2, 
            useCORS: true,
            allowTaint: true
        }).then(canvas => {
            var link = document.createElement('a');
            link.download = 'Peringatan_Banjir_Rob.png';
            link.href = canvas.toDataURL("image/png");
            link.click();
            btn.innerHTML = oriText;
        }).catch(err => {
            console.error(err);
            alert("Gagal render gambar.");
            btn.innerHTML = oriText;
        });
    }

</script>
</body>
</html>
